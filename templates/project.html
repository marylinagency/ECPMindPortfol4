{% extends "base.html" %}

{% block title %}{{ project.get('name', 'Project') }} - BookGenPro{% endblock %}

{% block content %}
<div data-project-id="{{ project.get('id', '') }}"></div>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" data-project-id="{{ project.get('id', '') }}">
    <!-- Project Header -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4 mb-4">
                    <a href="{{ url_for('index') }}" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="arrow-left" class="w-5 h-5"></i>
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                        onclick="editProjectTitle('{{ project.get('id', '') }}', '{{ project.get('name', 'Untitled') }}')" 
                        title="Click to edit title">
                        {{ project.get('name', 'Untitled Project') }}
                        <i data-feather="edit-2" class="w-4 h-4 inline ml-2 text-gray-400"></i>
                    </h1>
                    <span id="generation-status" class="status-badge status-{{ (project.get('generation_status', 'pending')).replace('_', '-') }}">
                        {% set status = project.get('generation_status', 'pending') %}
                        {% if status == 'pending' %}Ready to generate
                        {% elif status == 'generating_titles' %}Generating titles...
                        {% elif status == 'generating_content' %}Generating content...
                        {% elif status == 'completed' %}Generation completed
                        {% elif status and status.startswith('error:') %}Generation failed
                        {% else %}{{ status or 'Unknown' }}
                        {% endif %}
                    </span>
                </div>
                
                <p class="text-gray-600 mb-4 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                   onclick="editProjectDescription('{{ project.get('id', '') }}', '{{ project.get('topic', '') }}')" 
                   title="Click to edit description">
                    {{ project.get('topic', 'No description available') }}
                    <i data-feather="edit-2" class="w-4 h-4 inline ml-2 text-gray-400"></i>
                </p>
                
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                    <span class="flex items-center">
                        <i data-feather="globe" class="w-4 h-4 mr-1"></i>
                        {{ project.get('language', 'English') }}
                    </span>
                    <span class="flex items-center">
                        <i data-feather="file-text" class="w-4 h-4 mr-1"></i>
                        {{ (project.get('chapters', [])|length) }}/{{ project.get('num_chapters', 0) }} chapters
                    </span>
                    <span class="flex items-center">
                        <i data-feather="calendar" class="w-4 h-4 mr-1"></i>
                        Created {{ project.get('created_at', 'Unknown')[:10] if project.get('created_at') else 'Unknown' }}
                    </span>
                </div>
            </div>
            
            <div class="mt-6 lg:mt-0 lg:ml-8">
                <div class="w-32 h-44 rounded-lg overflow-hidden shadow-lg book-cover relative group">
                    {% if project.get('cover_image') %}
                    <img src="{{ url_for('static', filename='uploads/' + project.get('cover_image')) }}" 
                         alt="Book Cover" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <i data-feather="image" class="w-8 h-8 text-white"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Cover Upload Overlay -->
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="document.getElementById('coverUpload').click()" 
                                class="bg-white text-gray-800 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">
                            <i data-feather="upload" class="w-4 h-4 inline mr-1"></i>
                            Change Cover
                        </button>
                    </div>
                </div>
                
                <!-- Hidden file input -->
                <form method="POST" action="{{ url_for('upload_project_cover', project_id=project.get('id', '')) }}" enctype="multipart/form-data" id="coverForm" class="hidden">
                    <input type="file" id="coverUpload" name="cover_image" accept="image/*" onchange="document.getElementById('coverForm').submit()">
                </form>
            </div>
        </div>
        
        <!-- Writing Mood Tracker -->
        <div class="mt-8 bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 rounded-xl p-6">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-feather="heart" class="w-6 h-6 text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Writing Mood for This Project</h3>
                <p class="text-gray-600">How are you feeling about working on "{{ project.get('name', 'your project') }}" today?</p>
                
                <!-- Mood Streak Counter -->
                <div id="project-mood-streak" class="mt-4 inline-flex items-center space-x-2 bg-gradient-to-r from-pink-100 to-purple-100 px-4 py-2 rounded-full border border-pink-200">
                    <i data-feather="trending-up" class="w-4 h-4 text-pink-600"></i>
                    <span class="text-sm font-medium text-pink-800">Writing Streak: <span id="streak-days">0</span> days</span>
                </div>
            </div>
            
            <!-- Mood Selection -->
            <div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 gap-3 mb-6">
                <div class="project-mood-emoji" data-mood="excited" onclick="selectProjectMood('excited', '🤩', 'Excited')">
                    <span class="text-2xl">🤩</span>
                    <span class="text-xs text-gray-600 font-medium">Excited</span>
                </div>
                <div class="project-mood-emoji" data-mood="focused" onclick="selectProjectMood('focused', '🎯', 'Focused')">
                    <span class="text-2xl">🎯</span>
                    <span class="text-xs text-gray-600 font-medium">Focused</span>
                </div>
                <div class="project-mood-emoji" data-mood="creative" onclick="selectProjectMood('creative', '🎨', 'Creative')">
                    <span class="text-2xl">🎨</span>
                    <span class="text-xs text-gray-600 font-medium">Creative</span>
                </div>
                <div class="project-mood-emoji" data-mood="motivated" onclick="selectProjectMood('motivated', '💪', 'Motivated')">
                    <span class="text-2xl">💪</span>
                    <span class="text-xs text-gray-600 font-medium">Motivated</span>
                </div>
                <div class="project-mood-emoji" data-mood="inspired" onclick="selectProjectMood('inspired', '💡', 'Inspired')">
                    <span class="text-2xl">💡</span>
                    <span class="text-xs text-gray-600 font-medium">Inspired</span>
                </div>
                <div class="project-mood-emoji" data-mood="tired" onclick="selectProjectMood('tired', '😴', 'Tired')">
                    <span class="text-2xl">😴</span>
                    <span class="text-xs text-gray-600 font-medium">Tired</span>
                </div>
                <div class="project-mood-emoji" data-mood="blocked" onclick="selectProjectMood('blocked', '🧱', 'Blocked')">
                    <span class="text-2xl">🧱</span>
                    <span class="text-xs text-gray-600 font-medium">Blocked</span>
                </div>
                <div class="project-mood-emoji" data-mood="stressed" onclick="selectProjectMood('stressed', '😰', 'Stressed')">
                    <span class="text-2xl">😰</span>
                    <span class="text-xs text-gray-600 font-medium">Stressed</span>
                </div>
            </div>
            
            <!-- Mood Note -->
            <div class="mb-4">
                <textarea id="project-mood-note" 
                          class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-300 focus:outline-none resize-none"
                          rows="2" 
                          placeholder="Add a note about your writing mood for this project (optional)..."></textarea>
            </div>
            
            <!-- Save Button -->
            <div class="text-center mb-6">
                <button id="save-project-mood-btn" 
                        onclick="saveProjectMood()" 
                        class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-6 py-2 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-300 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-feather="heart" class="w-4 h-4 inline mr-2"></i>
                    Save Project Mood
                </button>
            </div>
            
            <!-- Project Mood History -->
            <div>
                <h4 class="text-lg font-semibold text-gray-800 mb-3 text-center">Your Writing Journey on This Project</h4>
                <div id="project-mood-history" class="flex gap-2 overflow-x-auto pb-2">
                    <!-- History will be populated here -->
                    <div class="flex-shrink-0 text-center text-gray-400">
                        <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center mb-2">
                            <i data-feather="calendar" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Progress Bar -->
        {% if project.get('generation_status') in ['generating_titles', 'generating_content'] %}
        <div class="mt-6">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                <span>Generation Progress</span>
                <span id="progress-text">{{ (project.get('chapters', [])|selectattr('status', 'equalto', 'completed')|list|length / (project.get('chapters', [])|length if project.get('chapters', [])|length > 0 else 1) * 100)|round|int if project.get('chapters') else 0 }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="generation-progress" class="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full progress-bar" 
                     style="width: {{ (project.get('chapters', [])|selectattr('status', 'equalto', 'completed')|list|length / (project.get('chapters', [])|length if project.get('chapters', [])|length > 0 else 1) * 100) if project.get('chapters') else 0 }}%"></div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-8">
        {% set status = project.get('generation_status', 'pending') %}
        {% if status == 'pending' or (status and status.startswith('error:')) %}
        <a href="{{ url_for('generate_chapters', project_id=project.get('id', '')) }}" 
           class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="cpu" class="w-5 h-5 inline mr-2"></i>
            Generate Chapters with AI
        </a>
        {% endif %}
        
        <!-- Cover Image Upload Button -->
        <button onclick="document.getElementById('coverUpload').click()" 
                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="image" class="w-5 h-5 inline mr-2"></i>
            {% if project.get('cover_image') %}Update Cover Image{% else %}Add Cover Image{% endif %}
        </button>
        
        {% if project.get('chapters') and project.get('generation_status') == 'completed' %}
        <a href="{{ url_for('book_preview', project_id=project.get('id', '')) }}" 
           class="bg-gradient-to-r from-green-600 to-teal-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium mr-4">
            <i data-feather="eye" class="w-5 h-5 inline mr-2"></i>
            Live Preview & Edit
        </a>
        
        <a href="{{ url_for('export_pdf', project_id=project.get('id', '')) }}" 
           class="bg-gradient-to-r from-red-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="download" class="w-5 h-5 inline mr-2"></i>
            Export as PDF
        </a>
        
        <a href="{{ url_for('export_docx', project_id=project.get('id', '')) }}" 
           class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="file-text" class="w-5 h-5 inline mr-2"></i>
            Export as DOCX
        </a>
        {% endif %}
        
        <!-- Delete Project Button -->
        <button onclick="deleteProject('{{ project.get('id', '') }}')" 
                class="bg-gradient-to-r from-red-700 to-red-800 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="trash-2" class="w-5 h-5 inline mr-2"></i>
            Delete Project
        </button>
    </div>
    
    <!-- Chapters Section -->
    {% if project.get('chapters') %}
    <div class="bg-white rounded-xl shadow-lg p-8 slide-in" id="chapters-container">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Chapters</h2>
        
        <div class="space-y-6">
            {% for chapter in project.get('chapters', []) %}
            <div class="chapter-card bg-gray-50 rounded-lg p-6 {{ chapter.get('status', 'pending') }}" data-chapter-id="{{ chapter.get('id', '') }}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 chapter-title">
                            Chapter {{ chapter.get('number', '?') }}: {{ chapter.get('title', 'Untitled') }}
                        </h3>
                        <div class="flex items-center mt-2">
                            <span class="status-badge status-{{ chapter.get('status', 'pending') }}">
                                {% set ch_status = chapter.get('status', 'pending') %}
                                {% if ch_status == 'pending' %}Pending
                                {% elif ch_status == 'generating' %}Generating...
                                {% elif ch_status == 'completed' %}Completed
                                {% elif ch_status == 'error' %}Error
                                {% else %}{{ ch_status|title }}
                                {% endif %}
                            </span>
                            {% if chapter.get('content') %}
                            <span class="ml-4 text-sm text-gray-500">
                                {{ chapter.get('content', '').split()|length }} words
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if chapter.get('status') == 'completed' %}
                    <button onclick="viewChapterFull('{{ chapter.get('id', '') }}')" 
                            class="text-purple-600 hover:text-purple-800 p-2 rounded-lg hover:bg-purple-50 transition-colors mr-2"
                            data-tooltip="View Full Chapter">
                        <i data-feather="maximize-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="editChapter('{{ chapter.get('id', '') }}')" 
                            class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors mr-2"
                            data-tooltip="Edit Chapter">
                        <i data-feather="edit-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="regenerateChapter('{{ project.get('id', '') }}', '{{ chapter.get('id', '') }}')" 
                            class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors"
                            data-tooltip="Regenerate Chapter">
                        <i data-feather="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    {% endif %}
                </div>
                
                {% if chapter.get('content') %}
                <div class="chapter-content prose max-w-none">
                    <div class="text-gray-700 line-clamp-4 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                         onclick="editChapterContent('{{ project.get('id', '') }}', '{{ chapter.get('id', '') }}', '{{ chapter.get('title', '')|replace("'", "\\'") }}', this)"
                         title="Click to edit content">
                        {{ chapter.get('content', '')[:300] }}...
                        <i data-feather="edit-2" class="w-4 h-4 inline ml-2 text-gray-400"></i>
                    </div>
                    {% if chapter.get('content', '')|length > 300 %}
                    <button class="text-blue-600 hover:text-blue-800 text-sm mt-2" onclick="toggleChapterContent(this)">
                        Show full content
                    </button>
                    <div class="hidden full-content mt-4 text-gray-700 whitespace-pre-wrap cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" 
                         onclick="editChapterContent('{{ project.get('id', '') }}', '{{ chapter.get('id', '') }}', '{{ chapter.get('title', '')|replace("'", "\\'") }}', this)"
                         title="Click to edit content">{{ chapter.get('content', '') }}<i data-feather="edit-2" class="w-4 h-4 inline ml-2 text-gray-400"></i></div>
                    {% endif %}
                </div>
                {% elif chapter.get('status') == 'generating' %}
                <div class="text-gray-500 italic">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        Generating content...
                    </div>
                </div>
                {% elif chapter.get('status') == 'error' %}
                <div class="text-red-600 italic">
                    Failed to generate content. Please try again.
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-feather="book-open" class="w-12 h-12 text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-4">No Chapters Generated Yet</h3>
        <p class="text-gray-600 mb-8 max-w-md mx-auto">
            Click "Generate Chapters with AI" to automatically create chapter titles and content based on your book topic.
        </p>
        <a href="{{ url_for('generate_chapters', project_id=project.get('id', '')) }}" 
           class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-8 py-4 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium inline-block">
            <i data-feather="cpu" class="w-5 h-5 inline mr-2"></i>
            Generate Chapters with AI
        </a>
    </div>
    {% endif %}
</div>

<script>
let statusCheckInterval;
let isGenerating = false;

function toggleChapterContent(button) {
    const fullContent = button.nextElementSibling;
    const preview = button.parentElement.querySelector('.line-clamp-4');
    
    if (fullContent.classList.contains('hidden')) {
        fullContent.classList.remove('hidden');
        preview.classList.add('hidden');
        button.textContent = 'Show less';
    } else {
        fullContent.classList.add('hidden');
        preview.classList.remove('hidden');
        button.textContent = 'Show full content';
    }
}

function regenerateChapter(projectId, chapterId) {
    if (confirm('Are you sure you want to regenerate this chapter? The current content will be replaced.')) {
        // Show loading modal immediately
        showRegenerationProgress(chapterId);
        
        // Start regeneration process
        fetch(`/regenerate_chapter/${projectId}/${chapterId}`, {
            method: 'GET'
        }).then(response => {
            if (response.ok) {
                // Start monitoring progress
                startProgressMonitoring(projectId, chapterId);
            } else {
                hideRegenerationProgress();
                showNotification('Failed to start regeneration', 'error');
            }
        }).catch(error => {
            hideRegenerationProgress();
            showNotification('Error starting regeneration', 'error');
        });
    }
}

function showRegenerationProgress(chapterId) {
    // Create progress modal
    const modal = document.createElement('div');
    modal.id = 'regeneration-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-feather="refresh-cw" class="w-8 h-8 text-white animate-spin"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Regenerating Chapter</h3>
                <p class="text-gray-600 mb-6">AI is creating new content for your chapter...</p>
                
                <!-- Progress bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Progress</span>
                        <span id="regeneration-percentage">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="regeneration-progress-bar" class="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Status text -->
                <p id="regeneration-status" class="text-sm text-blue-600 font-medium">Initializing...</p>
                
                <!-- Progress steps -->
                <div class="mt-6 space-y-2">
                    <div id="step-1" class="flex items-center text-sm">
                        <div class="w-4 h-4 rounded-full bg-blue-600 mr-3 flex items-center justify-center">
                            <i data-feather="check" class="w-3 h-3 text-white"></i>
                        </div>
                        <span class="text-gray-600">Preparing regeneration</span>
                    </div>
                    <div id="step-2" class="flex items-center text-sm">
                        <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                        <span class="text-gray-400">Generating content with AI</span>
                    </div>
                    <div id="step-3" class="flex items-center text-sm">
                        <div class="w-4 h-4 rounded-full bg-gray-300 mr-3"></div>
                        <span class="text-gray-400">Finalizing chapter</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function hideRegenerationProgress() {
    const modal = document.getElementById('regeneration-modal');
    if (modal) {
        modal.remove();
    }
}

function startProgressMonitoring(projectId, chapterId) {
    let progress = 0;
    let step = 1;
    
    const progressInterval = setInterval(() => {
        // Simulate progress steps
        if (step === 1) {
            progress = 25;
            updateProgressStep(2, 'Generating content with AI');
            step = 2;
        } else if (step === 2) {
            progress += 10;
            if (progress >= 80) {
                updateProgressStep(3, 'Finalizing chapter');
                step = 3;
            }
        }
        
        updateProgress(progress);
        
        // Check actual status from server
        fetch(`/api/chapter_status/${projectId}/${chapterId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    updateProgress(100);
                    updateProgressStep(3, 'Chapter regenerated successfully!');
                    setTimeout(() => {
                        hideRegenerationProgress();
                        location.reload();
                    }, 1500);
                    clearInterval(progressInterval);
                } else if (data.status === 'error') {
                    hideRegenerationProgress();
                    showNotification('Chapter regeneration failed', 'error');
                    clearInterval(progressInterval);
                }
            })
            .catch(() => {
                // Continue with simulated progress if API fails
            });
            
    }, 1000);
    
    // Fallback: stop after 30 seconds
    setTimeout(() => {
        clearInterval(progressInterval);
        if (document.getElementById('regeneration-modal')) {
            hideRegenerationProgress();
            location.reload();
        }
    }, 30000);
}

function updateProgress(percentage) {
    const progressBar = document.getElementById('regeneration-progress-bar');
    const percentageText = document.getElementById('regeneration-percentage');
    
    if (progressBar && percentageText) {
        progressBar.style.width = percentage + '%';
        percentageText.textContent = Math.round(percentage) + '%';
    }
}

function updateProgressStep(stepNumber, statusText) {
    const statusElement = document.getElementById('regeneration-status');
    if (statusElement) {
        statusElement.textContent = statusText;
    }
    
    // Update step visuals
    for (let i = 1; i <= stepNumber; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
            const circle = stepElement.querySelector('div');
            const text = stepElement.querySelector('span');
            circle.className = 'w-4 h-4 rounded-full bg-blue-600 mr-3 flex items-center justify-center';
            text.className = 'text-gray-600';
        }
    }
}

function viewChapterFull(chapterId) {
    // Get the chapter data
    const chapterCard = document.querySelector(`[data-chapter-id="${chapterId}"]`);
    const title = chapterCard.querySelector('.chapter-title').textContent;
    const content = chapterCard.querySelector('.full-content').textContent;
    
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">${title}</h2>
                <div class="flex space-x-2">
                    <button onclick="editChapterModal('${chapterId}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-feather="edit-2" class="w-4 h-4 mr-2"></i>
                        Edit
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="prose max-w-none">
                    <div class="text-gray-700 whitespace-pre-wrap leading-relaxed">${content}</div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function editChapterModal(chapterId) {
    const chapterCard = document.querySelector(`[data-chapter-id="${chapterId}"]`);
    const title = chapterCard.querySelector('.chapter-title').textContent;
    const content = chapterCard.querySelector('.full-content').textContent;
    
    // Close existing modal
    closeModal();
    
    // Create edit modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Edit Chapter</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chapter Title</label>
                        <input type="text" id="edit-title" value="${title.replace(/Chapter \d+: /, '')}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chapter Content</label>
                        <textarea id="edit-content" rows="15" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none">${content}</textarea>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-4">
                <button onclick="closeModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveChapterEdit('${chapterId}')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Changes
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function saveChapterEdit(chapterId) {
    const title = document.getElementById('edit-title').value;
    const content = document.getElementById('edit-content').value;
    
    fetch(`/save_chapter/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            location.reload();
        } else {
            alert('Error saving chapter: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving chapter: ' + error.message);
    });
}

function previewBook() {
    const projectId = document.querySelector('[data-project-id]').dataset.projectId;
    
    // Open book preview in new window/tab
    const previewUrl = `/book_preview/${projectId}`;
    window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

function editProjectTitle(projectId, currentTitle) {
    const newTitle = prompt('Edit Project Title:', currentTitle);
    if (newTitle && newTitle !== currentTitle) {
        fetch(`/api/update_project/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: newTitle
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating title: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating title: ' + error.message);
        });
    }
}

function editProjectDescription(projectId, currentDescription) {
    const newDescription = prompt('Edit Project Description:', currentDescription);
    if (newDescription && newDescription !== currentDescription) {
        fetch(`/api/update_project/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: newDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating description: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating description: ' + error.message);
        });
    }
}

function editChapterContent(projectId, chapterId, chapterTitle, element) {
    // Get current content
    const currentContent = element.textContent.replace(/✏️/g, '').trim();
    
    // Create modal for editing
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Edit Chapter: ${chapterTitle}</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chapter Content</label>
                        <textarea id="edit-chapter-content" rows="20" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none"
                                  placeholder="Enter chapter content here...">${currentContent}</textarea>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-4">
                <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveChapterContent('${projectId}', '${chapterId}', this)" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Changes
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function saveChapterContent(projectId, chapterId, button) {
    const content = document.getElementById('edit-chapter-content').value;
    
    button.disabled = true;
    button.textContent = 'Saving...';
    
    fetch(`/api/update_chapter`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            project_id: projectId,
            chapter_id: chapterId,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.closest('.fixed').remove();
            location.reload();
        } else {
            alert('Error saving chapter: ' + data.message);
            button.disabled = false;
            button.textContent = 'Save Changes';
        }
    })
    .catch(error => {
        alert('Error saving chapter: ' + error.message);
        button.disabled = false;
        button.textContent = 'Save Changes';
    });
}

function editChapter(chapterId) {
    // Use the modal version
    editChapterModal(chapterId);
}

function closeModal() {
    const modals = document.querySelectorAll('.fixed.inset-0');
    modals.forEach(modal => {
        if (modal.classList.contains('bg-black')) {
            document.body.removeChild(modal);
        }
    });
}

function showNotification(message, type = 'info') {
    // Create notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full opacity-0`;
    
    // Set color based on type
    if (type === 'error') {
        notification.className += ' bg-red-500 text-white';
    } else if (type === 'success') {
        notification.className += ' bg-green-500 text-white';
    } else {
        notification.className += ' bg-blue-500 text-white';
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <i data-feather="x" class="w-4 h-4"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    feather.replace();
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

function deleteProject(projectId) {
    if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        // Create a form and submit it to delete the project
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_project/${projectId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function saveChapter(chapterId, content) {
    // You'll need to implement this API endpoint
    fetch(`/save_chapter/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({content: content})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error saving chapter: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving chapter: ' + error.message);
    });
}

function checkGenerationStatus() {
    const projectId = document.querySelector('[data-project-id]').dataset.projectId;
    
    fetch(`/api/project_status/${projectId}`)
        .then(response => response.json())
        .then(data => {
            updateGenerationStatus(data);
            
            // Keep checking if still generating
            if (data.status === 'generating_titles' || data.status === 'generating_content') {
                isGenerating = true;
                setTimeout(checkGenerationStatus, 2000);
            } else {
                isGenerating = false;
                if (data.status === 'completed') {
                    // Reload page to show completed chapters
                    setTimeout(() => location.reload(), 1000);
                }
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            isGenerating = false;
        });
}

function updateGenerationStatus(data) {
    // Update status badge
    const statusBadge = document.getElementById('generation-status');
    if (statusBadge) {
        let statusText = '';
        let statusClass = 'status-pending';
        
        switch(data.status) {
            case 'pending':
                statusText = 'Ready to generate';
                statusClass = 'status-pending';
                break;
            case 'enhancing_description':
                statusText = 'Enhancing description...';
                statusClass = 'status-generating';
                break;
            case 'generating_titles':
                statusText = 'Generating titles...';
                statusClass = 'status-generating';
                break;
            case 'generating_content':
                statusText = `Generating content... (${data.completed_chapters}/${data.total_chapters} completed)`;
                statusClass = 'status-generating';
                break;
            case 'completed':
                statusText = 'Generation completed';
                statusClass = 'status-completed';
                break;
            default:
                if (data.status.startsWith('error:')) {
                    statusText = 'Generation failed';
                    statusClass = 'status-error';
                } else {
                    statusText = data.status;
                    statusClass = 'status-pending';
                }
        }
        
        statusBadge.textContent = statusText;
        statusBadge.className = `status-badge ${statusClass}`;
    }
    
    // Update progress bar
    const progressBar = document.getElementById('generation-progress');
    const progressText = document.getElementById('progress-text');
    if (progressBar && data.progress !== undefined) {
        progressBar.style.width = data.progress + '%';
        if (progressText) {
            progressText.textContent = Math.round(data.progress) + '%';
        }
    }
    
    // Update individual chapters
    if (data.chapters) {
        data.chapters.forEach(chapter => {
            const chapterCard = document.querySelector(`[data-chapter-id="${chapter.id}"]`);
            if (chapterCard) {
                const statusBadge = chapterCard.querySelector('.status-badge');
                if (statusBadge) {
                    let statusText = chapter.status === 'completed' ? 'Completed' : 
                                   chapter.status === 'generating' ? 'Generating...' : 
                                   chapter.status === 'error' ? 'Error' : 'Pending';
                    statusBadge.textContent = statusText;
                    statusBadge.className = `status-badge status-${chapter.status}`;
                }
            }
        });
    }
}

// Check for ongoing generation when page loads
document.addEventListener('DOMContentLoaded', function() {
    const currentStatus = '{{ project.generation_status }}';
    if (currentStatus === 'generating_titles' || currentStatus === 'generating_content') {
        isGenerating = true;
        checkGenerationStatus();
    }
});
</script>
{% endblock %}
