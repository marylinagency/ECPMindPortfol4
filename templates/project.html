{% extends "base.html" %}

{% block title %}{{ project.name }} - BookGenPro{% endblock %}

{% block content %}
<div data-project-id="{{ project.id }}"></div>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" data-project-id="{{ project.id }}">
    <!-- Project Header -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4 mb-4">
                    <a href="{{ url_for('index') }}" class="text-gray-500 hover:text-gray-700">
                        <i data-feather="arrow-left" class="w-5 h-5"></i>
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900">{{ project.name }}</h1>
                    <span id="generation-status" class="status-badge status-{{ project.generation_status.replace('_', '-') if project.generation_status else 'pending' }}">
                        {% if project.generation_status == 'pending' %}Ready to generate
                        {% elif project.generation_status == 'generating_titles' %}Generating titles...
                        {% elif project.generation_status == 'generating_content' %}Generating content...
                        {% elif project.generation_status == 'completed' %}Generation completed
                        {% elif project.generation_status.startswith('error:') %}Generation failed
                        {% else %}{{ project.generation_status }}
                        {% endif %}
                    </span>
                </div>
                
                <p class="text-gray-600 mb-4">{{ project.topic }}</p>
                
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                    <span class="flex items-center">
                        <i data-feather="globe" class="w-4 h-4 mr-1"></i>
                        {{ project.language }}
                    </span>
                    <span class="flex items-center">
                        <i data-feather="file-text" class="w-4 h-4 mr-1"></i>
                        {{ project.chapters|length }}/{{ project.num_chapters }} chapters
                    </span>
                    <span class="flex items-center">
                        <i data-feather="calendar" class="w-4 h-4 mr-1"></i>
                        Created {{ project.created_at[:10] }}
                    </span>
                </div>
            </div>
            
            <div class="mt-6 lg:mt-0 lg:ml-8">
                <div class="w-32 h-44 rounded-lg overflow-hidden shadow-lg book-cover relative group">
                    {% if project.cover_image %}
                    <img src="{{ url_for('static', filename='uploads/' + project.cover_image) }}" 
                         alt="Book Cover" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <i data-feather="image" class="w-8 h-8 text-white"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Cover Upload Overlay -->
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="document.getElementById('coverUpload').click()" 
                                class="bg-white text-gray-800 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-colors">
                            <i data-feather="upload" class="w-4 h-4 inline mr-1"></i>
                            Change Cover
                        </button>
                    </div>
                </div>
                
                <!-- Hidden file input -->
                <form method="POST" action="{{ url_for('upload_project_cover', project_id=project.id) }}" enctype="multipart/form-data" id="coverForm" class="hidden">
                    <input type="file" id="coverUpload" name="cover_image" accept="image/*" onchange="document.getElementById('coverForm').submit()">
                </form>
            </div>
        </div>
        
        <!-- Progress Bar -->
        {% if project.generation_status in ['generating_titles', 'generating_content'] %}
        <div class="mt-6">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                <span>Generation Progress</span>
                <span id="progress-text">{{ (project.chapters|selectattr('status', 'equalto', 'completed')|list|length / (project.chapters|length if project.chapters|length > 0 else 1) * 100)|round|int if project.chapters else 0 }}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="generation-progress" class="bg-gradient-to-r from-blue-600 to-purple-600 h-2 rounded-full progress-bar" 
                     style="width: {{ (project.chapters|selectattr('status', 'equalto', 'completed')|list|length / (project.chapters|length if project.chapters|length > 0 else 1) * 100) if project.chapters else 0 }}%"></div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mb-8">
        {% if project.generation_status == 'pending' or project.generation_status.startswith('error:') %}
        <a href="{{ url_for('generate_chapters', project_id=project.id) }}" 
           class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="cpu" class="w-5 h-5 inline mr-2"></i>
            Generate Chapters with AI
        </a>
        {% endif %}
        
        <!-- Cover Image Upload Button -->
        <button onclick="document.getElementById('coverUpload').click()" 
                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="image" class="w-5 h-5 inline mr-2"></i>
            {% if project.cover_image %}Update Cover Image{% else %}Add Cover Image{% endif %}
        </button>
        
        {% if project.chapters and project.generation_status == 'completed' %}
        <button onclick="previewBook()" 
                class="bg-gradient-to-r from-green-600 to-teal-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium mr-4">
            <i data-feather="eye" class="w-5 h-5 inline mr-2"></i>
            Preview Full Book
        </button>
        
        <a href="{{ url_for('export_pdf', project_id=project.id) }}" 
           class="bg-gradient-to-r from-red-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <i data-feather="download" class="w-5 h-5 inline mr-2"></i>
            Export as PDF
        </a>
        {% endif %}
    </div>
    
    <!-- Chapters Section -->
    {% if project.chapters %}
    <div class="bg-white rounded-xl shadow-lg p-8 slide-in" id="chapters-container">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Chapters</h2>
        
        <div class="space-y-6">
            {% for chapter in project.chapters %}
            <div class="chapter-card bg-gray-50 rounded-lg p-6 {{ chapter.status }}" data-chapter-id="{{ chapter.id }}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 chapter-title">
                            Chapter {{ chapter.number }}: {{ chapter.title }}
                        </h3>
                        <div class="flex items-center mt-2">
                            <span class="status-badge status-{{ chapter.status }}">
                                {% if chapter.status == 'pending' %}Pending
                                {% elif chapter.status == 'generating' %}Generating...
                                {% elif chapter.status == 'completed' %}Completed
                                {% elif chapter.status == 'error' %}Error
                                {% else %}{{ chapter.status|title }}
                                {% endif %}
                            </span>
                            {% if chapter.content %}
                            <span class="ml-4 text-sm text-gray-500">
                                {{ chapter.content.split()|length }} words
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if chapter.status == 'completed' %}
                    <button onclick="viewChapterFull('{{ chapter.id }}')" 
                            class="text-purple-600 hover:text-purple-800 p-2 rounded-lg hover:bg-purple-50 transition-colors mr-2"
                            data-tooltip="View Full Chapter">
                        <i data-feather="maximize-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="editChapter('{{ chapter.id }}')" 
                            class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors mr-2"
                            data-tooltip="Edit Chapter">
                        <i data-feather="edit-2" class="w-5 h-5"></i>
                    </button>
                    <button onclick="regenerateChapter('{{ project.id }}', '{{ chapter.id }}')" 
                            class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors"
                            data-tooltip="Regenerate Chapter">
                        <i data-feather="refresh-cw" class="w-5 h-5"></i>
                    </button>
                    {% endif %}
                </div>
                
                {% if chapter.content %}
                <div class="chapter-content prose max-w-none">
                    <div class="text-gray-700 line-clamp-4">
                        {{ chapter.content[:300] }}...
                    </div>
                    {% if chapter.content|length > 300 %}
                    <button class="text-blue-600 hover:text-blue-800 text-sm mt-2" onclick="toggleChapterContent(this)">
                        Show full content
                    </button>
                    <div class="hidden full-content mt-4 text-gray-700 whitespace-pre-wrap">{{ chapter.content }}</div>
                    {% endif %}
                </div>
                {% elif chapter.status == 'generating' %}
                <div class="text-gray-500 italic">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        Generating content...
                    </div>
                </div>
                {% elif chapter.status == 'error' %}
                <div class="text-red-600 italic">
                    Failed to generate content. Please try again.
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-feather="book-open" class="w-12 h-12 text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-4">No Chapters Generated Yet</h3>
        <p class="text-gray-600 mb-8 max-w-md mx-auto">
            Click "Generate Chapters with AI" to automatically create chapter titles and content based on your book topic.
        </p>
        <a href="{{ url_for('generate_chapters', project_id=project.id) }}" 
           class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-8 py-4 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium inline-block">
            <i data-feather="cpu" class="w-5 h-5 inline mr-2"></i>
            Generate Chapters with AI
        </a>
    </div>
    {% endif %}
</div>

<script>
let statusCheckInterval;
let isGenerating = false;

function toggleChapterContent(button) {
    const fullContent = button.nextElementSibling;
    const preview = button.parentElement.querySelector('.line-clamp-4');
    
    if (fullContent.classList.contains('hidden')) {
        fullContent.classList.remove('hidden');
        preview.classList.add('hidden');
        button.textContent = 'Show less';
    } else {
        fullContent.classList.add('hidden');
        preview.classList.remove('hidden');
        button.textContent = 'Show full content';
    }
}

function regenerateChapter(projectId, chapterId) {
    if (confirm('Are you sure you want to regenerate this chapter? The current content will be replaced.')) {
        window.location.href = `/regenerate_chapter/${projectId}/${chapterId}`;
    }
}

function viewChapterFull(chapterId) {
    // Get the chapter data
    const chapterCard = document.querySelector(`[data-chapter-id="${chapterId}"]`);
    const title = chapterCard.querySelector('.chapter-title').textContent;
    const content = chapterCard.querySelector('.full-content').textContent;
    
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">${title}</h2>
                <div class="flex space-x-2">
                    <button onclick="editChapterModal('${chapterId}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-feather="edit-2" class="w-4 h-4 mr-2"></i>
                        Edit
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="prose max-w-none">
                    <div class="text-gray-700 whitespace-pre-wrap leading-relaxed">${content}</div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function editChapterModal(chapterId) {
    const chapterCard = document.querySelector(`[data-chapter-id="${chapterId}"]`);
    const title = chapterCard.querySelector('.chapter-title').textContent;
    const content = chapterCard.querySelector('.full-content').textContent;
    
    // Close existing modal
    closeModal();
    
    // Create edit modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-full overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Edit Chapter</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chapter Title</label>
                        <input type="text" id="edit-title" value="${title.replace(/Chapter \d+: /, '')}" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chapter Content</label>
                        <textarea id="edit-content" rows="15" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none">${content}</textarea>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-4">
                <button onclick="closeModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveChapterEdit('${chapterId}')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Changes
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    feather.replace();
}

function saveChapterEdit(chapterId) {
    const title = document.getElementById('edit-title').value;
    const content = document.getElementById('edit-content').value;
    
    fetch(`/save_chapter/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: title,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            location.reload();
        } else {
            alert('Error saving chapter: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving chapter: ' + error.message);
    });
}

function previewBook() {
    const projectId = document.querySelector('[data-project-id]').dataset.projectId;
    
    // Open book preview in new window/tab
    const previewUrl = `/book_preview/${projectId}`;
    window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

function editChapter(chapterId) {
    // Use the modal version
    editChapterModal(chapterId);
}

function closeModal() {
    const modals = document.querySelectorAll('.fixed.inset-0');
    modals.forEach(modal => {
        if (modal.classList.contains('bg-black')) {
            document.body.removeChild(modal);
        }
    });
}

function saveChapter(chapterId, content) {
    // You'll need to implement this API endpoint
    fetch(`/save_chapter/${chapterId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({content: content})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error saving chapter: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving chapter: ' + error.message);
    });
}

function checkGenerationStatus() {
    const projectId = document.querySelector('[data-project-id]').dataset.projectId;
    
    fetch(`/api/project_status/${projectId}`)
        .then(response => response.json())
        .then(data => {
            updateGenerationStatus(data);
            
            // Keep checking if still generating
            if (data.status === 'generating_titles' || data.status === 'generating_content') {
                isGenerating = true;
                setTimeout(checkGenerationStatus, 2000);
            } else {
                isGenerating = false;
                if (data.status === 'completed') {
                    // Reload page to show completed chapters
                    setTimeout(() => location.reload(), 1000);
                }
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            isGenerating = false;
        });
}

function updateGenerationStatus(data) {
    // Update status badge
    const statusBadge = document.getElementById('generation-status');
    if (statusBadge) {
        let statusText = '';
        let statusClass = 'status-pending';
        
        switch(data.status) {
            case 'pending':
                statusText = 'Ready to generate';
                statusClass = 'status-pending';
                break;
            case 'generating_titles':
                statusText = 'Generating titles...';
                statusClass = 'status-generating';
                break;
            case 'generating_content':
                statusText = `Generating content... (${data.completed_chapters}/${data.total_chapters} completed)`;
                statusClass = 'status-generating';
                break;
            case 'completed':
                statusText = 'Generation completed';
                statusClass = 'status-completed';
                break;
            default:
                if (data.status.startsWith('error:')) {
                    statusText = 'Generation failed';
                    statusClass = 'status-error';
                } else {
                    statusText = data.status;
                    statusClass = 'status-pending';
                }
        }
        
        statusBadge.textContent = statusText;
        statusBadge.className = `status-badge ${statusClass}`;
    }
    
    // Update progress bar
    const progressBar = document.getElementById('generation-progress');
    const progressText = document.getElementById('progress-text');
    if (progressBar && data.progress !== undefined) {
        progressBar.style.width = data.progress + '%';
        if (progressText) {
            progressText.textContent = Math.round(data.progress) + '%';
        }
    }
    
    // Update individual chapters
    if (data.chapters) {
        data.chapters.forEach(chapter => {
            const chapterCard = document.querySelector(`[data-chapter-id="${chapter.id}"]`);
            if (chapterCard) {
                const statusBadge = chapterCard.querySelector('.status-badge');
                if (statusBadge) {
                    let statusText = chapter.status === 'completed' ? 'Completed' : 
                                   chapter.status === 'generating' ? 'Generating...' : 
                                   chapter.status === 'error' ? 'Error' : 'Pending';
                    statusBadge.textContent = statusText;
                    statusBadge.className = `status-badge status-${chapter.status}`;
                }
            }
        });
    }
}

// Check for ongoing generation when page loads
document.addEventListener('DOMContentLoaded', function() {
    const currentStatus = '{{ project.generation_status }}';
    if (currentStatus === 'generating_titles' || currentStatus === 'generating_content') {
        isGenerating = true;
        checkGenerationStatus();
    }
});
</script>
{% endblock %}
