{% extends "base.html" %}

{% block title %}Settings - BookGenPro{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
        <!-- Header -->
        <div class="flex items-center mb-8">
            <a href="{{ url_for('index') }}" class="text-gray-500 hover:text-gray-700 mr-4">
                <i data-feather="arrow-left" class="w-5 h-5"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
        </div>
        
        <!-- API Configuration -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">API Configuration</h2>
            
            <form method="POST" action="{{ url_for('save_settings') }}" data-validate>
                <div class="space-y-6">
                    <!-- AI Provider Selection -->
                    <div>
                        <label for="ai_provider" class="block text-sm font-medium text-gray-700 mb-2">
                            AI Provider
                        </label>
                        <select id="ai_provider" name="ai_provider" 
                                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onchange="toggleProviderSettings()">
                            <option value="openrouter" {{ 'selected' if config.ai_provider == 'openrouter' else '' }}>
                                OpenRouter (Multiple AI Models)
                            </option>
                            <option value="gemini" {{ 'selected' if config.ai_provider == 'gemini' else '' }}>
                                Google Gemini (Direct API)
                            </option>
                        </select>
                        <p class="mt-2 text-sm text-gray-600">
                            Choose between OpenRouter (access to many models) or Google Gemini (direct access)
                        </p>
                    </div>

                    <!-- OpenRouter Settings -->
                    <div id="openrouter-settings" style="display: {{ 'block' if config.ai_provider != 'gemini' else 'none' }}">
                        <!-- OpenRouter API Key -->
                        <div>
                        <label for="openrouter_api_key" class="block text-sm font-medium text-gray-700 mb-2">
                            OpenRouter API Key
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input type="password" id="openrouter_api_key" name="openrouter_api_key" 
                                   value="{{ config.openrouter_api_key }}"
                                   class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                                   placeholder="Enter your OpenRouter API key">
                            <button type="button" onclick="togglePasswordVisibility('openrouter_api_key')" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                <i data-feather="eye" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="mt-2 text-sm text-gray-600">
                            Get your API key from 
                            <a href="https://openrouter.ai" target="_blank" class="text-blue-600 hover:text-blue-800">OpenRouter.ai</a>
                        </p>
                    </div>
                    
                    <!-- Model Selection -->
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 mb-2">
                            AI Model
                        </label>
                        <select id="model" name="model" 
                                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            
                            <!-- Free Models Section -->
                            <optgroup label="ðŸ†“ Free Models (No Cost)">
                                <option value="meta-llama/llama-3.2-3b-instruct:free" {{ 'selected' if config.selected_model == 'meta-llama/llama-3.2-3b-instruct:free' else '' }}>
                                    Llama 3.2 3B Instruct (Free)
                                </option>
                                <option value="meta-llama/llama-3.2-1b-instruct:free" {{ 'selected' if config.selected_model == 'meta-llama/llama-3.2-1b-instruct:free' else '' }}>
                                    Llama 3.2 1B Instruct (Free)
                                </option>
                                <option value="microsoft/phi-3-mini-128k-instruct:free" {{ 'selected' if config.selected_model == 'microsoft/phi-3-mini-128k-instruct:free' else '' }}>
                                    Phi-3 Mini 128K (Free)
                                </option>
                                <option value="microsoft/phi-3-medium-128k-instruct:free" {{ 'selected' if config.selected_model == 'microsoft/phi-3-medium-128k-instruct:free' else '' }}>
                                    Phi-3 Medium 128K (Free)
                                </option>
                                <option value="huggingface/zephyr-7b-beta:free" {{ 'selected' if config.selected_model == 'huggingface/zephyr-7b-beta:free' else '' }}>
                                    Zephyr 7B Beta (Free)
                                </option>
                                <option value="openchat/openchat-7b:free" {{ 'selected' if config.selected_model == 'openchat/openchat-7b:free' else '' }}>
                                    OpenChat 7B (Free)
                                </option>
                                <option value="openrouter/auto" {{ 'selected' if config.selected_model == 'openrouter/auto' else '' }}>
                                    Auto (OpenRouter Chooses Best Free Model)
                                </option>
                                <option value="nousresearch/nous-capybara-7b:free" {{ 'selected' if config.selected_model == 'nousresearch/nous-capybara-7b:free' else '' }}>
                                    Nous Capybara 7B (Free)
                                </option>
                                <option value="mistralai/mistral-7b-instruct:free" {{ 'selected' if config.selected_model == 'mistralai/mistral-7b-instruct:free' else '' }}>
                                    Mistral 7B Instruct (Free)
                                </option>
                                <option value="google/gemma-7b-it:free" {{ 'selected' if config.selected_model == 'google/gemma-7b-it:free' else '' }}>
                                    Gemma 7B IT (Free)
                                </option>
                                <option value="google/gemma-2b-it:free" {{ 'selected' if config.selected_model == 'google/gemma-2b-it:free' else '' }}>
                                    Gemma 2B IT (Free)
                                </option>
                                <option value="toppy/undi95-toppy-m-7b:free" {{ 'selected' if config.selected_model == 'toppy/undi95-toppy-m-7b:free' else '' }}>
                                    Toppy M 7B (Free)
                                </option>
                                <option value="undi95/remm-slerp-l2-13b:free" {{ 'selected' if config.selected_model == 'undi95/remm-slerp-l2-13b:free' else '' }}>
                                    ReMM SLERP L2 13B (Free)
                                </option>
                                <option value="gryphe/mythomist-7b:free" {{ 'selected' if config.selected_model == 'gryphe/mythomist-7b:free' else '' }}>
                                    Mythomist 7B (Free)
                                </option>
                                <option value="undi95/toppy-m-7b:free" {{ 'selected' if config.selected_model == 'undi95/toppy-m-7b:free' else '' }}>
                                    Toppy M 7B Alt (Free)
                                </option>
                            </optgroup>
                            
                            <!-- Premium Models Section -->
                            <optgroup label="ðŸ’Ž Premium Models (Paid)">
                                <option value="openai/gpt-3.5-turbo" {{ 'selected' if config.selected_model == 'openai/gpt-3.5-turbo' else '' }}>
                                    GPT-3.5 Turbo (Fast & Cost-effective)
                                </option>
                                <option value="openai/gpt-4" {{ 'selected' if config.selected_model == 'openai/gpt-4' else '' }}>
                                    GPT-4 (Higher Quality)
                                </option>
                                <option value="openai/gpt-4-turbo" {{ 'selected' if config.selected_model == 'openai/gpt-4-turbo' else '' }}>
                                    GPT-4 Turbo (Balanced)
                                </option>
                                <option value="openai/gpt-4o" {{ 'selected' if config.selected_model == 'openai/gpt-4o' else '' }}>
                                    GPT-4O (Latest)
                                </option>
                                <option value="anthropic/claude-3-haiku" {{ 'selected' if config.selected_model == 'anthropic/claude-3-haiku' else '' }}>
                                    Claude 3 Haiku (Fast)
                                </option>
                                <option value="anthropic/claude-3-sonnet" {{ 'selected' if config.selected_model == 'anthropic/claude-3-sonnet' else '' }}>
                                    Claude 3 Sonnet (Balanced)
                                </option>
                                <option value="anthropic/claude-3-opus" {{ 'selected' if config.selected_model == 'anthropic/claude-3-opus' else '' }}>
                                    Claude 3 Opus (Highest Quality)
                                </option>
                                <option value="meta-llama/llama-3.1-405b-instruct" {{ 'selected' if config.selected_model == 'meta-llama/llama-3.1-405b-instruct' else '' }}>
                                    Llama 3.1 405B (Largest)
                                </option>
                                <option value="meta-llama/llama-3.1-70b-instruct" {{ 'selected' if config.selected_model == 'meta-llama/llama-3.1-70b-instruct' else '' }}>
                                    Llama 3.1 70B
                                </option>
                                <option value="google/gemini-pro-1.5" {{ 'selected' if config.selected_model == 'google/gemini-pro-1.5' else '' }}>
                                    Gemini Pro 1.5
                                </option>
                            </optgroup>
                        </select>
                        <p class="mt-2 text-sm text-gray-600">
                            Free models are great for testing. Premium models offer better quality and faster responses.
                        </p>
                        <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-sm text-green-800">
                                <i data-feather="info" class="w-4 h-4 inline mr-1"></i>
                                <strong>Free Models:</strong> No cost, perfect for testing and light usage (rate limited)
                            </p>
                        </div>
                    </div>
                    </div>

                    <!-- Gemini Settings -->
                    <div id="gemini-settings" style="display: {{ 'block' if config.ai_provider == 'gemini' else 'none' }}">
                        <!-- Gemini API Key -->
                        <div>
                            <label for="gemini_api_key" class="block text-sm font-medium text-gray-700 mb-2">
                                Google Gemini API Key
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <input type="password" id="gemini_api_key" name="gemini_api_key" 
                                       value="{{ config.gemini_api_key }}"
                                       class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                                       placeholder="Enter your Gemini API key">
                                <button type="button" onclick="togglePasswordVisibility('gemini_api_key')" 
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                    <i data-feather="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">
                                Get your API key from 
                                <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-600 hover:text-blue-800">Google AI Studio</a>
                            </p>
                        </div>

                        <!-- Gemini Model Selection -->
                        <div>
                            <label for="gemini_model" class="block text-sm font-medium text-gray-700 mb-2">
                                Gemini Model
                            </label>
                            <select id="gemini_model" name="gemini_model" 
                                    class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="gemini-1.5-flash" {{ 'selected' if config.gemini_model == 'gemini-1.5-flash' else '' }}>
                                    Gemini 1.5 Flash (Fast & Efficient)
                                </option>
                                <option value="gemini-1.5-pro" {{ 'selected' if config.gemini_model == 'gemini-1.5-pro' else '' }}>
                                    Gemini 1.5 Pro (Higher Quality)
                                </option>
                                <option value="gemini-pro" {{ 'selected' if config.gemini_model == 'gemini-pro' else '' }}>
                                    Gemini Pro (Standard)
                                </option>
                            </select>
                            <p class="mt-2 text-sm text-gray-600">
                                Gemini 1.5 Flash is recommended for speed and cost efficiency.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
                            <i data-feather="save" class="w-5 h-5 inline mr-2"></i>
                            Save Settings
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- License Information -->
        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">License Information</h2>
            
            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center mr-4">
                        <i data-feather="check" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-green-900">License Active</h3>
                        <p class="text-green-700">Your BookGenPro license is active and valid</p>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-green-900">License Type:</span>
                        <span class="text-green-700 ml-2">{{ config.license_info.license_type if config.license_info else 'Standard' }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-green-900">Email:</span>
                        <span class="text-green-700 ml-2">{{ config.email }}</span>
                    </div>
                    <div>
                        <span class="font-medium text-green-900">Machine ID:</span>
                        <span class="text-green-700 ml-2 font-mono text-xs">{{ config.machine_id }}</span>
                    </div>
                    {% if config.license_info and config.license_info.expires_at %}
                    <div>
                        <span class="font-medium text-green-900">Expires:</span>
                        <span class="text-green-700 ml-2">{{ config.license_info.expires_at }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- API Usage Guidelines -->
        <div class="border-t border-gray-200 pt-8 mt-8">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">API Usage Guidelines</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-3">OpenRouter Setup</h3>
                    <ol class="text-sm text-blue-800 space-y-2">
                        <li class="flex items-start">
                            <span class="flex-shrink-0 w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-medium mr-3 mt-0.5">1</span>
                            Visit <a href="https://openrouter.ai" target="_blank" class="text-blue-600 hover:underline">OpenRouter.ai</a>
                        </li>
                        <li class="flex items-start">
                            <span class="flex-shrink-0 w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-medium mr-3 mt-0.5">2</span>
                            Create an account and add credits
                        </li>
                        <li class="flex items-start">
                            <span class="flex-shrink-0 w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-medium mr-3 mt-0.5">3</span>
                            Generate an API key from the dashboard
                        </li>
                        <li class="flex items-start">
                            <span class="flex-shrink-0 w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-medium mr-3 mt-0.5">4</span>
                            Paste the API key in the field above
                        </li>
                    </ol>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-yellow-900 mb-3">Model Selection Guide</h3>
                    <ul class="text-sm text-yellow-800 space-y-2">
                        <li class="flex items-start">
                            <i data-feather="gift" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                            Free Models: Perfect for testing and learning (no cost)
                        </li>
                        <li class="flex items-start">
                            <i data-feather="zap" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                            Llama 3.2 3B: Best free model for book generation
                        </li>
                        <li class="flex items-start">
                            <i data-feather="dollar-sign" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                            GPT-3.5 Turbo: Most cost-effective premium option
                        </li>
                        <li class="flex items-start">
                            <i data-feather="star" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                            GPT-4: Best quality for professional books
                        </li>
                        <li class="flex items-start">
                            <i data-feather="info" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                            Monitor usage on OpenRouter dashboard
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- System Information -->
        <div class="border-t border-gray-200 pt-8 mt-8">
            <h2 class="text-2xl font-semibold text-gray-900 mb-6">System Information</h2>
            
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="grid md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-medium text-gray-900">Version:</span>
                        <span class="text-gray-700 ml-2">BookGenPro v1.0</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Developer:</span>
                        <span class="text-gray-700 ml-2">ECPMind</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-900">Support:</span>
                        <a href="https://www.ecertifpro.com" target="_blank" class="text-blue-600 hover:text-blue-800 ml-2">www.ecertifpro.com</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const iconContainer = input.nextElementSibling;
    const icon = iconContainer ? iconContainer.querySelector('i') : null;
    
    if (!input || !icon) return;
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-feather', 'eye-off');
    } else {
        input.type = 'password';
        icon.setAttribute('data-feather', 'eye');
    }
    
    feather.replace();
}

function toggleProviderSettings() {
    const providerSelect = document.getElementById('ai_provider');
    const openrouterSettings = document.getElementById('openrouter-settings');
    const geminiSettings = document.getElementById('gemini-settings');
    
    if (!providerSelect || !openrouterSettings || !geminiSettings) return;
    
    const provider = providerSelect.value;
    
    if (provider === 'gemini') {
        openrouterSettings.style.display = 'none';
        geminiSettings.style.display = 'block';
    } else {
        openrouterSettings.style.display = 'block';
        geminiSettings.style.display = 'none';
    }
}

// Initialize provider settings on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleProviderSettings();
});
</script>
{% endblock %}
